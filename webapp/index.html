<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #000000;
      --hint: #666666;
      --card-bg: #ffffff;
      --border: rgba(0,0,0,.18);
      --button-bg: #ffffff;
      --button-text: #000000;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto; padding: 16px; background: var(--bg); color: var(--text); }
    .row { margin: 12px 0; }
    label { display:block; margin-bottom: 6px; font-weight: 600; }
    input, textarea { width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }
    button { width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; background: var(--button-bg); color: var(--button-text); border: 1px solid var(--border); }
    .muted { color: var(--hint); font-size: 13px; margin-top: 6px; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin: 10px 0; background: var(--card-bg); }
    .title { font-weight: 700; font-size: 16px; margin-bottom: 6px; display:flex; align-items:center; flex-wrap:wrap; gap:8px; }
    .meta { font-size: 14px; line-height: 1.35; }
    .btnrow { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .btn { flex: 1 1 140px; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--button-bg); color: var(--button-text); }
    .tabs { display:flex; gap:8px; margin: 10px 0 14px; }
    .tab { flex:1; padding:10px; border-radius:10px; border:1px solid var(--border); background: var(--button-bg); color: var(--button-text); }
    .tab.active { font-weight:700; }
    .badge { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); }
  </style>
</head>
<body>
  <h3 id="titleH">–ù–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞</h3>

  <!-- CREATE/EDIT FORM -->
  <div id="modeCreateEdit">
    <button id="backBtn" style="display:none">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    <div class="row">
      <label>–î–∞—Ç–∞</label>
      <input id="date" type="date"/>
    </div>

    <div class="row">
      <label>–í—Ä–µ–º—è</label>
      <input id="time" type="time"/>
    </div>

    <div class="row">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="title" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –ö–≤–∏–∑"/>
    </div>

    <div class="row">
      <label>–°—Ç–æ–∏–º–æ—Å—Ç—å</label>
      <input id="cost" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 800 —Ä—É–±"/>
    </div>

    <div class="row">
      <label>–õ–æ–∫–∞—Ü–∏—è</label>
      <input id="location" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –ë–∞—Ä ¬´–ü–∏–Ω–≥–≤–∏–Ω¬ª"/>
    </div>

    <div class="row">
      <label>–î–µ—Ç–∞–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <textarea id="details" rows="4" placeholder="–∫–∞–∫ –Ω–∞–π—Ç–∏—Å—å, —á—Ç–æ –≤–∑—è—Ç—å –∏ —Ç.–¥."></textarea>
    </div>

    <button id="send">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div class="muted" id="hint"></div>
  </div>

  <!-- CALENDAR -->
  <div id="modeCalendar" style="display:none">
    <div class="tabs" id="tabs">
      <button class="tab active" id="tabAll">–í—Å–µ</button>
      <button class="tab" id="tabGo">–ò–¥—É</button>
      <button class="tab" id="tabRevote">–ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>
    </div>
    <div class="muted" id="calHint">–ó–∞–≥—Ä—É–∂–∞—é –≤—Å—Ç—Ä–µ—á–∏‚Ä¶</div>
    <div id="list"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    function $(id) { return document.getElementById(id); }

    // querystring (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–µ—Ä–µ–∑ t.me/<bot>/<app>)
    const qs = new URLSearchParams(location.search);

    // Telegram Mini App –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–ø—É—Å–∫–∞ (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ ?startapp=... –≤ —Å—Å—ã–ª–∫–µ t.me)
    const sp = (tg.initDataUnsafe && tg.initDataUnsafe.start_param)
      ? String(tg.initDataUnsafe.start_param)
      : "";

    // startapp format from bot: cal_<chatid>_<sig>  OR  create_<chatid>_<sig>
    let spMode = "";   // "cal" | "create"
    let spChatId = "";
    let spSig = "";

    if (sp) {
      const parts = sp.split("_");
      if (parts.length >= 3) {
        spMode = parts[0];
        spChatId = parts[1];
        spSig = parts.slice(2).join("_");
      }
    }

    // mode can come from query (?mode=calendar) OR from start_param (cal)
    const mode = qs.get("mode") || (spMode === "cal" ? "calendar" : (spMode === "manage" ? "manage" : ""));
    const eventId = qs.get("event_id") || "";
    const backMode = qs.get("back") || "";
    const apiBase = qs.get("api_base") || "";

    // chat context can come from query OR start_param
    const chatId = qs.get("chat_id") || spChatId;
    const sig = qs.get("sig") || spSig;
    const userId = qs.get("user_id") || "";
    const userSig = qs.get("user_sig") || "";

    // UI refs
    const titleH = $("titleH");
    const modeCreateEdit = $("modeCreateEdit");
    const modeCalendar = $("modeCalendar");
    const hint = $("hint");

    const dateEl = $("date");
    const timeEl = $("time");
    const tEl = $("title");
    const costEl = $("cost");
    const locEl = $("location");
    const detailsEl = $("details");
    const sendBtn = $("send");
    const backBtn = $("backBtn");

    const tabAll = $("tabAll");
    const tabGo = $("tabGo");
    const tabRevote = $("tabRevote");
    const tabsEl = $("tabs");
    const calHint = $("calHint");
    const list = $("list");

    function applyTheme() {
      if (!tg || !tg.themeParams) return;
      const t = tg.themeParams;
      const root = document.documentElement;
      const set = (name, val) => { if (val) root.style.setProperty(name, val); };
      set("--bg", t.bg_color);
      set("--text", t.text_color);
      set("--hint", t.hint_color);
      set("--card-bg", t.section_bg_color || t.secondary_bg_color);
      set("--border", t.section_separator_color);
      set("--button-bg", t.button_color || t.section_bg_color);
      set("--button-text", t.button_text_color || t.text_color);
    }

    function setTabsEnabled(enabled) {
      tabGo.disabled = !enabled;
      tabRevote.disabled = !enabled;
    }

    function warnNotWebApp(strict) {
      if (!tg || !tg.initData || tg.initData.length === 0) {
        const msg = "–≠—Ç–æ –Ω–µ Web App. –û—Ç–∫—Ä–æ–π —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞ –≤ —á–∞—Ç–µ.";
        hint.textContent = msg;
        calHint.textContent = msg;
        return !!strict;
      }
      return false;
    }

    applyTheme();
    // ---------- calendar ----------
    let allItems = [];
    let activeFilter = "all"; // all | go | revote

    function setActiveTab(which) {
      activeFilter = which;
      [tabAll, tabGo, tabRevote].forEach(b => b.classList.remove("active"));
      if (which === "all") tabAll.classList.add("active");
      if (which === "go") tabGo.classList.add("active");
      if (which === "revote") tabRevote.classList.add("active");
      renderList();
    }

    tabAll.onclick = () => setActiveTab("all");
    tabGo.onclick = () => setActiveTab("go");
    tabRevote.onclick = () => setActiveTab("revote");

    function fmt(dtIso) {
      const d = new Date(dtIso);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function dayNotEnded(dtIso) {
      const d = new Date(dtIso);
      const now = new Date();
      const a = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      const b = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
      return a >= b;
    }

    function eventNotStarted(dtIso) {
      const d = new Date(dtIso);
      return d.getTime() > Date.now();
    }

    function voteBadge(v) {
      if (v === "yes") return "–Ø –≤ –¥–µ–ª–µ";
      if (v === "maybe") return "–ù–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å";
      if (v === "no") return "–ù–µ —Å–º–æ–≥—É";
      return null;
    }

    function filteredItems() {
      if (activeFilter === "all") return allItems;
      if (activeFilter === "go") return allItems.filter(it => it.my_vote === "yes" && dayNotEnded(it.dt_iso));
      if (activeFilter === "revote") return allItems.filter(it => it.my_vote === "maybe" && eventNotStarted(it.dt_iso));
      return allItems;
    }

    function appUrl(params) {
      const base = `${location.origin}${location.pathname}`;
      const url = new URL(base);
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== "") url.searchParams.set(k, v);
      });
      return url.toString();
    }

    async function deleteEvent(id) {
      const ok = confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.");
      if (!ok) return;
      if (mode !== "manage" && tg && tg.sendData) {
        tg.sendData(JSON.stringify({ action: "delete", event_id: id }));
        tg.close();
        return;
      }
      let url = `${apiBase}/api/event/${id}`;
      if (userId && userSig) {
        url += `?user_id=${encodeURIComponent(userId)}&user_sig=${encodeURIComponent(userSig)}`;
      }
      const resp = await fetch(url, {
        method: "DELETE",
        headers: { "X-Telegram-InitData": tg.initData }
      });
      if (!resp.ok) {
        const t = await resp.text().catch(() => "");
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: " + t);
        return;
      }
      await loadCalendar();
    }

    function renderList() {
      const items = filteredItems();
      list.innerHTML = "";

      if (!items.length) {
        calHint.textContent = activeFilter === "all"
          ? "–ë–ª–∏–∂–∞–π—à–∏—Ö –≤—Å—Ç—Ä–µ—á –Ω–µ—Ç."
          : "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É.";
        return;
      }
      calHint.textContent = "";

      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "card";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = it.title;

        const badgeText = voteBadge(it.my_vote);
        if (badgeText) {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = badgeText;
          title.appendChild(badge);
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `üïí ${fmt(it.dt_iso)}<br>üìç ${it.location}<br>üí∏ ${it.cost}`;

        const btnRow = document.createElement("div");
        btnRow.className = "btnrow";

        if (mode === "manage") {
          const editUrl = appUrl({
            event_id: it.id,
            chat_id: chatId,
            sig: sig,
            user_id: userId,
            user_sig: userSig,
            back: "manage"
          });

          const btnEdit = document.createElement("button");
          btnEdit.className = "btn";
          btnEdit.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
          btnEdit.onclick = () => { location.href = editUrl; };

          const btnDel = document.createElement("button");
          btnDel.className = "btn";
          btnDel.textContent = "–£–¥–∞–ª–∏—Ç—å";
          btnDel.onclick = () => { deleteEvent(it.id); };

          btnRow.appendChild(btnEdit);
          btnRow.appendChild(btnDel);
        } else {
          const btnOpen = document.createElement("button");
          btnOpen.className = "btn";
          btnOpen.textContent = it.poll_link ? "–û—Ç–∫—Ä—ã—Ç—å –æ–ø—Ä–æ—Å" : "–û—Ç–∫—Ä—ã—Ç—å (–Ω–µ—Ç —Å—Å—ã–ª–∫–∏)";
          btnOpen.disabled = !it.poll_link;
          btnOpen.onclick = () => { if (it.poll_link) tg.openTelegramLink(it.poll_link); };

          const btnIcs = document.createElement("button");
          btnIcs.className = "btn";
          btnIcs.textContent = "–î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å";
          btnIcs.onclick = () => {
            tg.sendData(JSON.stringify({ action: "ics_request", event_id: it.id }));
            tg.close();
          };

          btnRow.appendChild(btnOpen);
          btnRow.appendChild(btnIcs);
        }

        div.appendChild(title);
        div.appendChild(meta);
        div.appendChild(btnRow);

        list.appendChild(div);
      });
    }

    async function loadCalendar() {
      const hasIdentity = !!(tg && tg.initData) || (!!userId && !!userSig);
      warnNotWebApp(false);
      setTabsEnabled(hasIdentity && mode !== "manage");
      tabsEl.style.display = mode === "manage" ? "none" : "flex";
      if (!hasIdentity) {
        calHint.textContent = "–§–∏–ª—å—Ç—Ä—ã ¬´–ò–¥—É¬ª –∏ ¬´–ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å¬ª —Ç—Ä–µ–±—É—é—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é. –û—Ç–∫—Ä–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞.";
      }
      titleH.textContent = mode === "manage" ? "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∞–º–∏" : "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤—Å—Ç—Ä–µ—á";
      modeCreateEdit.style.display = "none";
      modeCalendar.style.display = "block";

      if (!chatId || !sig) {
        calHint.textContent = "–ù–µ –≤–∏–∂—É –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–∞—Ç–∞ (chat_id/sig). –û—Ç–∫—Ä–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∫–Ω–æ–ø–∫–æ–π –∏–∑ –Ω—É–∂–Ω–æ–≥–æ —á–∞—Ç–∞.";
        return;
      }

      calHint.textContent = "–ó–∞–≥—Ä—É–∂–∞—é –≤—Å—Ç—Ä–µ—á–∏‚Ä¶";
      let url = `${apiBase}/api/calendar/upcoming?chat_id=${encodeURIComponent(chatId)}&sig=${encodeURIComponent(sig)}&limit=100`;
      if (userId && userSig) {
        url += `&user_id=${encodeURIComponent(userId)}&user_sig=${encodeURIComponent(userSig)}`;
      }
      const resp = await fetch(url, { headers: { "X-Telegram-InitData": tg.initData } });

      if (!resp.ok) {
        calHint.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å—Ç—Ä–µ—á–∏.";
        return;
      }

      allItems = await resp.json();
      setActiveTab("all");
    }

    // ---------- form ----------
    function isoWithOffset(date, time) {
      const local = new Date(`${date}T${time}:00`);
      const tzOffsetMin = local.getTimezoneOffset();
      const pad = (n) => String(Math.abs(n)).padStart(2, "0");
      const sign = tzOffsetMin <= 0 ? "+" : "-";
      const offH = pad(Math.floor(Math.abs(tzOffsetMin) / 60));
      const offM = pad(Math.abs(tzOffsetMin) % 60);
      return `${date}T${time}:00${sign}${offH}:${offM}`;
    }

    function setFromIso(dtIso) {
      const dt = new Date(dtIso);
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth() + 1).padStart(2, "0");
      const dd = String(dt.getDate()).padStart(2, "0");
      const hh = String(dt.getHours()).padStart(2, "0");
      const mi = String(dt.getMinutes()).padStart(2, "0");
      dateEl.value = `${yyyy}-${mm}-${dd}`;
      timeEl.value = `${hh}:${mi}`;
    }

    async function loadEvent(id) {
      titleH.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏";
      hint.textContent = "–§–æ—Ä–º–∞ –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶";

      const resp = await fetch(`${apiBase}/api/event/${id}`);
      if (!resp.ok) {
        hint.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ.";
        return;
      }
      const e = await resp.json();
      setFromIso(e.dt_iso);
      tEl.value = e.title || "";
      costEl.value = e.cost || "";
      locEl.value = e.location || "";
      detailsEl.value = e.details || "";
      hint.textContent = "";
    }

    async function putEvent(id, patch) {
      let url = `${apiBase}/api/event/${id}`;
      if (userId && userSig) {
        url += `?user_id=${encodeURIComponent(userId)}&user_sig=${encodeURIComponent(userSig)}`;
      }
      const resp = await fetch(url, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Telegram-InitData": tg.initData
        },
        body: JSON.stringify(patch)
      });
      if (!resp.ok) {
        const t = await resp.text().catch(() => "");
        throw new Error(`API error ${resp.status}: ${t}`);
      }
    }

    async function initForm() {
      warnNotWebApp(true);
      titleH.textContent = eventId ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏" : "–ù–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞";
      modeCreateEdit.style.display = "block";
      modeCalendar.style.display = "none";
      if (eventId && (backMode === "manage" || mode === "manage")) {
        backBtn.style.display = "block";
        backBtn.onclick = () => {
          const backUrl = appUrl({
            mode: "manage",
            chat_id: chatId,
            sig: sig,
            user_id: userId,
            user_sig: userSig
          });
          location.href = backUrl;
        };
      }

      if (eventId) {
        try { await loadEvent(eventId); } catch (_) { hint.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏."; }
      } else {
        hint.textContent = "";
      }

      sendBtn.onclick = async () => {
        const date = dateEl.value || "";
        const time = timeEl.value || "";

        if (!date || !time) {
          hint.textContent = "–ù—É–∂–Ω—ã –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è.";
          return;
        }

        const title = (tEl.value || "–í—Å—Ç—Ä–µ—á–∞").trim();
        const cost = (costEl.value || "-").trim();
        const location = (locEl.value || "-").trim();
        const details = (detailsEl.value || "").trim();

        // CREATE: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–º–µ—Å—Ç–µ —Å chat_id –∏ sig
        if (!eventId) {
          if (!chatId || !sig) {
            hint.textContent = "–ù–µ –≤–∏–∂—É chat_id/sig. –û—Ç–∫—Ä–æ–π —Ñ–æ—Ä–º—É –∫–Ω–æ–ø–∫–æ–π –∏–∑ –Ω—É–∂–Ω–æ–≥–æ —á–∞—Ç–∞.";
            return;
          }

          tg.sendData(JSON.stringify({
            action: "create",
            chat_id: chatId,
            sig: sig,
            date, time, title, cost, location, details
          }));
          tg.close();
          return;
        }

        // EDIT: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ API
        try {
          const dtIso = isoWithOffset(date, time);
          await putEvent(eventId, { dt_iso: dtIso, title, cost, location, details });
          tg.sendData(JSON.stringify({ action: "edited_via_api", event_id: Number(eventId) }));
          if (backMode === "manage") {
            const backUrl = appUrl({
              mode: "manage",
              chat_id: chatId,
              sig: sig,
              user_id: userId,
              user_sig: userSig
            });
            location.href = backUrl;
          } else {
            tg.close();
          }
        } catch (e) {
          hint.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: " + e.message;
        }
      };
    }

    // ---------- router ----------
    if (mode === "calendar" || mode === "manage") {
      loadCalendar().catch(() => calHint.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.");
    } else {
      initForm().catch(() => hint.textContent = "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.");
    }
  </script>
</body>
</html>
