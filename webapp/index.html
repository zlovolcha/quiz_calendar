<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto; padding: 16px; }
    .row { margin: 12px 0; }
    label { display:block; margin-bottom: 6px; font-weight: 600; }
    input, textarea { width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    button { width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; }
    .muted { color: #666; font-size: 13px; margin-top: 6px; }
    .card { border: 1px solid rgba(0,0,0,.12); border-radius: 12px; padding: 12px; margin: 10px 0; }
    .title { font-weight: 700; font-size: 16px; margin-bottom: 6px; }
    .meta { font-size: 14px; line-height: 1.35; }
    .btnrow { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .btn { flex: 1 1 140px; padding: 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,.18); background: #fff; }
    .tabs { display:flex; gap:8px; margin: 10px 0 14px; }
    .tab { flex:1; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,.18); background:#fff; }
    .tab.active { font-weight:700; }
    .badge { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.18); margin-left:8px; }
  </style>
</head>
<body>
  <h3 id="titleH">–ù–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞</h3>

  <div id="modeCreateEdit">
    <div class="row">
      <label>–î–∞—Ç–∞</label>
      <input id="date" type="date"/>
    </div>

    <div class="row">
      <label>–í—Ä–µ–º—è</label>
      <input id="time" type="time"/>
    </div>

    <div class="row">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="title" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –ö–≤–∏–∑"/>
    </div>

    <div class="row">
      <label>–°—Ç–æ–∏–º–æ—Å—Ç—å</label>
      <input id="cost" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 10‚Ç¨"/>
    </div>

    <div class="row">
      <label>–õ–æ–∫–∞—Ü–∏—è</label>
      <input id="location" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –ë–∞—Ä ¬´–ü–∏–Ω–≥–≤–∏–Ω¬ª"/>
    </div>

    <div class="row">
      <label>–î–µ—Ç–∞–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <textarea id="details" rows="4" placeholder="–∫–∞–∫ –Ω–∞–π—Ç–∏—Å—å, —á—Ç–æ –≤–∑—è—Ç—å –∏ —Ç.–¥."></textarea>
    </div>

    <button id="send">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div class="muted" id="hint"></div>
  </div>

  <div id="modeCalendar" style="display:none">
    <div class="tabs">
      <button class="tab active" id="tabAll">–í—Å–µ</button>
      <button class="tab" id="tabGo">–ò–¥—É</button>
      <button class="tab" id="tabRevote">–ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>
    </div>
    <div class="muted" id="calHint">–ó–∞–≥—Ä—É–∂–∞—é –≤—Å—Ç—Ä–µ—á–∏‚Ä¶</div>
    <div id="list"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const qs = new URLSearchParams(location.search);

    const mode = qs.get("mode") || "";          // "calendar" | ""
    const eventId = qs.get("event_id");
    const apiBase = qs.get("api_base") || "";

    const chatId = qs.get("chat_id");
    const sig = qs.get("sig");

    const h = document.getElementById("titleH");
    const hint = document.getElementById("hint");

    const modeCreateEdit = document.getElementById("modeCreateEdit");
    const modeCalendar = document.getElementById("modeCalendar");
    const calHint = document.getElementById("calHint");
    const list = document.getElementById("list");

    const tabAll = document.getElementById("tabAll");
    const tabGo = document.getElementById("tabGo");
    const tabRevote = document.getElementById("tabRevote");

    let allItems = [];
    let activeFilter = "all"; // all | go | revote

    function setActiveTab(which) {
      activeFilter = which;
      [tabAll, tabGo, tabRevote].forEach(b => b.classList.remove("active"));
      if (which === "all") tabAll.classList.add("active");
      if (which === "go") tabGo.classList.add("active");
      if (which === "revote") tabRevote.classList.add("active");
      renderList();
    }

    tabAll.onclick = () => setActiveTab("all");
    tabGo.onclick = () => setActiveTab("go");
    tabRevote.onclick = () => setActiveTab("revote");

    function setFromIso(dtIso) {
      const dt = new Date(dtIso);
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth() + 1).padStart(2, "0");
      const dd = String(dt.getDate()).padStart(2, "0");
      const hh = String(dt.getHours()).padStart(2, "0");
      const mi = String(dt.getMinutes()).padStart(2, "0");
      document.getElementById("date").value = `${yyyy}-${mm}-${dd}`;
      document.getElementById("time").value = `${hh}:${mi}`;
    }

    async function loadEvent(id) {
      h.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏";
      hint.textContent = "–§–æ—Ä–º–∞ –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶";
      const resp = await fetch(`${apiBase}/api/event/${id}`);
      if (!resp.ok) {
        hint.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ.";
        return;
      }
      const e = await resp.json();
      setFromIso(e.dt_iso);
      document.getElementById("title").value = e.title || "";
      document.getElementById("cost").value = e.cost || "";
      document.getElementById("location").value = e.location || "";
      document.getElementById("details").value = e.details || "";
      hint.textContent = "";
    }

    async function putEvent(id, patch) {
      const resp = await fetch(`${apiBase}/api/event/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Telegram-InitData": tg.initData
        },
        body: JSON.stringify(patch)
      });
      if (!resp.ok) {
        const t = await resp.text().catch(() => "");
        throw new Error(`API error ${resp.status}: ${t}`);
      }
    }

    function isoWithOffset(date, time) {
      const local = new Date(`${date}T${time}:00`);
      const tzOffsetMin = local.getTimezoneOffset();
      const pad = (n) => String(Math.abs(n)).padStart(2, "0");
      const sign = tzOffsetMin <= 0 ? "+" : "-";
      const offH = pad(Math.floor(Math.abs(tzOffsetMin) / 60));
      const offM = pad(Math.abs(tzOffsetMin) % 60);
      return `${date}T${time}:00${sign}${offH}:${offM}`;
    }

    function fmt(dtIso) {
      const d = new Date(dtIso);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    // "–î–µ–Ω—å —Å–æ–±—ã—Ç–∏—è –µ—â—ë –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è" = —Å–æ–±—ã—Ç–∏–µ –≤ —Ç–æ—Ç –∂–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –¥–µ–Ω—å –∏–ª–∏ –ø–æ–∑–∂–µ (–ø–æ –ª–æ–∫–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    function dayNotEnded(dtIso) {
      const d = new Date(dtIso);
      const now = new Date();
      // —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ YYYY-MM-DD
      const a = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      const b = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
      return a >= b;
    }

    function eventNotStarted(dtIso) {
      const d = new Date(dtIso);
      return d.getTime() > Date.now();
    }

    function voteBadge(v) {
      if (v === "yes") return "–Ø –≤ –¥–µ–ª–µ";
      if (v === "maybe") return "–ù–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å";
      if (v === "no") return "–ù–µ —Å–º–æ–≥—É";
      return null;
    }

    function filteredItems() {
      if (activeFilter === "all") return allItems;

      if (activeFilter === "go") {
        // "–∏–¥—É" = my_vote yes –∏ –¥–µ–Ω—å —Å–æ–±—ã—Ç–∏—è –µ—â–µ –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è
        return allItems.filter(it => it.my_vote === "yes" && dayNotEnded(it.dt_iso));
      }

      if (activeFilter === "revote") {
        // "–ø–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å" = my_vote maybe –∏ —Å–æ–±—ã—Ç–∏–µ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª–æ
        return allItems.filter(it => it.my_vote === "maybe" && eventNotStarted(it.dt_iso));
      }

      return allItems;
    }

    function renderList() {
      const items = filteredItems();
      list.innerHTML = "";

      if (!items.length) {
        calHint.textContent = activeFilter === "all"
          ? "–ë–ª–∏–∂–∞–π—à–∏—Ö –≤—Å—Ç—Ä–µ—á –Ω–µ—Ç."
          : "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É.";
        return;
      }
      calHint.textContent = "";

      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "card";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = it.title;

        const badgeText = voteBadge(it.my_vote);
        if (badgeText) {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = badgeText;
          title.appendChild(badge);
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `üïí ${fmt(it.dt_iso)}<br>üìç ${it.location}<br>üí∏ ${it.cost}`;

        const btnRow = document.createElement("div");
        btnRow.className = "btnrow";

        const btnOpen = document.createElement("button");
        btnOpen.className = "btn";
        btnOpen.textContent = it.poll_link ? "–û—Ç–∫—Ä—ã—Ç—å –æ–ø—Ä–æ—Å" : "–û—Ç–∫—Ä—ã—Ç—å (–Ω–µ—Ç —Å—Å—ã–ª–∫–∏)";
        btnOpen.disabled = !it.poll_link;
        btnOpen.onclick = () => {
          if (it.poll_link) tg.openTelegramLink(it.poll_link);
        };

        const btnIcs = document.createElement("button");
        btnIcs.className = "btn";
        btnIcs.textContent = "–î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å";
        btnIcs.onclick = () => {
          tg.sendData(JSON.stringify({ action: "ics_request", event_id: it.id }));
          tg.close();
        };

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn";
        btnEdit.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
        btnEdit.onclick = () => {
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–æ–π –∂–µ —Ñ–æ—Ä–º–µ
          // –ï—Å–ª–∏ —É —Ç–µ–±—è /event-form, —Ç–æ –ª—É—á—à–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å:
          // location.href = `/event-form?event_id=${it.id}`
          location.href = `/event-form?event_id=${encodeURIComponent(it.id)}`;
        };

        btnRow.appendChild(btnOpen);
        btnRow.appendChild(btnIcs);
        btnRow.appendChild(btnEdit);

        div.appendChild(title);
        div.appendChild(meta);
        div.appendChild(btnRow);

        list.appendChild(div);
      });
    }

    async function loadCalendar() {
      h.textContent = "–ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤—Å—Ç—Ä–µ—á";
      modeCreateEdit.style.display = "none";
      modeCalendar.style.display = "block";

      if (!chatId || !sig) {
        calHint.textContent = "–ù–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–∞—Ç–∞ (chat_id/sig). –û—Ç–∫—Ä–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∫–Ω–æ–ø–∫–æ–π –∏–∑ —á–∞—Ç–∞.";
        return;
      }

      calHint.textContent = "–ó–∞–≥—Ä—É–∂–∞—é –≤—Å—Ç—Ä–µ—á–∏‚Ä¶";

      const url = `${apiBase}/api/calendar/upcoming?chat_id=${encodeURIComponent(chatId)}&sig=${encodeURIComponent(sig)}&limit=100`;
      const resp = await fetch(url, {
        headers: { "X-Telegram-InitData": tg.initData }
      });

      if (!resp.ok) {
        calHint.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å—Ç—Ä–µ—á–∏.";
        return;
      }

      allItems = await resp.json();
      // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "–í—Å–µ"
      setActiveTab("all");
    }

    if (mode === "calendar") {
      loadCalendar().catch(() => calHint.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.");
    } else {
      modeCreateEdit.style.display = "block";
      modeCalendar.style.display = "none";

      if (eventId) loadEvent(eventId).catch(() => hint.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.");

      document.getElementById("send").onclick = async () => {
        const date = document.getElementById("date").value;
        const time = document.getElementById("time").value;
        if (!date || !time) {
          hint.textContent = "–ù—É–∂–Ω—ã –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è.";
          return;
        }

        const title = (document.getElementById("title").value || "–í—Å—Ç—Ä–µ—á–∞").trim();
        const cost = (document.getElementById("cost").value || "-").trim();
        const locationVal = (document.getElementById("location").value || "-").trim();
        const details = (document.getElementById("details").value || "").trim();

        if (!eventId) {
          tg.sendData(JSON.stringify({
            action: "create",
            date, time,
            title, cost, location: locationVal, details
          }));
          tg.close();
          return;
        }

        try {
          const dtIso = isoWithOffset(date, time);
          await putEvent(eventId, {
            dt_iso: dtIso,
            title, cost,
            location: locationVal,
            details
          });

          tg.sendData(JSON.stringify({ action:"edited_via_api", event_id: Number(eventId) }));
          tg.close();
        } catch (e) {
          hint.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: " + e.message;
        }
      };
    }
  </script>
</body>
</html>
